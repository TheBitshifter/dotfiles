#!/usr/bin/env ruby

require "oj"
require "progress-bar"

FILE_PATH = "tmp/output.json"

if !File.new(FILE_PATH).read
  items = File.new(".git/tags").read.split("\n").inject([]) {|res, line| res << line.split("\t").first }.uniq
  bar = ProgressBar.new(items.length, "items")

  result = items.inject({}) do |res, item|
    res[item] = `ag #{item} -c`.split("\n").inject({}) {|res, line| res.merge!(Hash[*line.split(":")]) }
    bar.inc!
    res
  end

  File.open(FILE_PATH, "w") { |file| file << Oj.dump(result) }
end

results = Oj.load(File.new(FILE_PATH).read)

trimmed_results = results.reject {|k, v| v.length == 0 }
one_file = trimmed_results.select {|k,v| v.length == 1 }
one_occurrence = one_file.select {|k,v| v.values.first.to_i == 1 }
non_controller_one_occurrence = one_occurrence.reject {|k, v| v.keys.first =~ /app\/controllers|lib\/|migrate/ }

puts non_controller_one_occurrence.keys.reject {|k| k =~ /^[A-Z]|=/ }
